<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TMDB Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
      form { display: flex; gap: .5rem; margin-bottom: 1rem; }
      input[type="text"] { flex: 1; padding: .5rem; }
      button { padding: .5rem .75rem; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: .75rem; }
      .title { font-weight: 700; margin: .25rem 0; }
      .muted { color: #666; font-size: .9rem; }
      img { width: 100%; border-radius: 8px; }
      .pager { margin-top: 1rem; display: flex; gap: .5rem; align-items: center; }
    </style>
  </head>
  <body>
    <h1>TMDB Search</h1>
    <form id="f">
      <input id="q" type="text" placeholder="Search movies or TV…" />
      <button>Search</button>
    </form>
    <div id="results" class="grid"></div>
    <div class="pager">
      <button id="prev">Prev</button>
      <span id="pageInfo"></span>
      <button id="next">Next</button>
    </div>

    <script>
      const resultsEl = document.getElementById("results");
      const pageInfoEl = document.getElementById("pageInfo");
      const input = document.getElementById("q");
      const form = document.getElementById("f");
      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      let state = { q: "", page: 1, total_pages: 1 };

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        state.q = input.value.trim();
        state.page = 1;
        await runSearch();
      });

      prevBtn.onclick = async () => {
        if (state.page > 1) { state.page--; await runSearch(); }
      };
      nextBtn.onclick = async () => {
        if (state.page < state.total_pages) { state.page++; await runSearch(); }
      };

      async function runSearch() {
        if (!state.q) return;
        resultsEl.innerHTML = "Searching…";
        const res = await fetch(`/api/search?q=${encodeURIComponent(state.q)}&page=${state.page}`);
        const data = await res.json();

        state.page = data.page || 1;
        state.total_pages = data.total_pages || 1;
        pageInfoEl.textContent = `Page ${state.page} of ${state.total_pages}`;

        resultsEl.innerHTML = "";
        (data.items || []).forEach((it) => {
          const card = document.createElement("div");
          card.className = "card";
          const img = it.poster_path
            ? `<img src="https://image.tmdb.org/t/p/w342${it.poster_path}" alt="poster" />`
            : "";
          card.innerHTML = `
            ${img}
            <div class="title">${it.title}</div>
            <div class="muted">${it.media_type.toUpperCase()} ${it.year ? "• " + it.year : ""}</div>
            <p>${(it.overview || "").slice(0, 180)}</p>
            <button data-type="${it.media_type}" data-id="${it.id}">Details</button>
          `;
          card.querySelector("button").onclick = () => showDetails(it.media_type, it.id);
          resultsEl.appendChild(card);
        });
      }

      async function showDetails(type, id) {
        const res = await fetch(`/api/title/${type}/${id}`);
        const d = await res.json();
        alert(`${d.title} (${d.year})
Rating: ${d.vote_average ?? "N/A"}
Genres: ${(d.genres || []).join(", ")}
Cast: ${(d.credits?.cast || []).map(c => c.name).join(", ")}`);
      }
    </script>
  </body>
</html>

